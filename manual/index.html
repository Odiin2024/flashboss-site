<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlashBoss Manual</title>
    <link rel="stylesheet" href="style.css?v=5">
    <link rel="icon" type="image/png" href="../icon.png">
    <style>
        /* Manual wrapper */
        .manual-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 3vh 8vw;
            box-sizing: border-box;
        }

        /* Top bar */
        .top-bar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 0.5rem;
        }

        .view-toggle {
            background: rgba(10, 10, 25, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 102, 255, 0.2);
            border-radius: 4px;
            color: var(--grey);
            padding: 0.3rem 0.75rem;
            cursor: pointer;
            transition: border-color 0.2s, color 0.2s;
            font-size: 0.75rem;
        }

        .view-toggle:hover {
            border-color: rgba(255, 102, 255, 0.4);
            color: var(--moon-cream);
        }

        /* Main content panel - frosted glass */
        .manual-panel {
            flex: 1;
            background: rgba(10, 10, 25, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 8px;
            border: 1px solid rgba(255, 102, 255, 0.2);
            box-shadow:
                0 0 20px rgba(255, 102, 255, 0.3),
                0 0 40px rgba(255, 102, 255, 0.15),
                0 0 60px rgba(126, 200, 255, 0.1);
            display: grid;
            grid-template-columns: 1fr 1fr;
            overflow: hidden;
        }

        /* Left column */
        .panel-left {
            display: flex;
            flex-direction: column;
            border-right: 2px solid rgba(255, 102, 255, 0.6);
            box-shadow: inset -8px 0 15px -10px rgba(255, 102, 255, 0.5);
        }

        .left-header {
            padding: 1rem 1.5rem 1rem 2.5rem;
            position: relative;
        }

        .left-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 1.5rem;
            right: 1.5rem;
            height: 1px;
            background: rgba(255, 102, 255, 0.3);
        }

        .screen-title {
            font-family: var(--font-pixel);
            font-size: 0.85rem;
            color: var(--moon-cream);
            margin: 0;
        }

        .left-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem 1.5rem;
        }

        .focus-image-link {
            display: block;
            text-decoration: none;
            transition: transform 0.2s;
        }

        .focus-image-link:hover {
            transform: scale(1.02);
        }

        .focus-image-link:hover .focus-image {
            border-color: rgba(255, 102, 255, 0.5);
            box-shadow: 0 0 20px rgba(255, 102, 255, 0.4), 0 0 35px rgba(255, 102, 255, 0.2);
        }

        .focus-image {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 6px;
            border: 1px solid rgba(255, 102, 255, 0.3);
            box-shadow: 0 0 10px rgba(255, 102, 255, 0.2);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .focus-placeholder {
            width: 300px;
            height: 200px;
            background: rgba(10, 10, 25, 0.5);
            border-radius: 6px;
            border: 1px solid rgba(255, 102, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--grey);
            font-size: 0.9rem;
        }

        .left-footer {
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
            color: var(--grey);
            font-style: italic;
            text-align: center;
        }

        /* Right column */
        .panel-right {
            display: flex;
            flex-direction: column;
        }

        .right-header {
            padding: 1rem 1.5rem 1rem 1.5rem;
            position: relative;
        }

        .right-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 1.5rem;
            right: 1.5rem;
            height: 1px;
            background: rgba(255, 102, 255, 0.3);
        }

        .screen-subheader {
            font-family: var(--font-pixel);
            font-size: 0.85rem;
            color: var(--link-blue);
            margin: 0;
        }

        /* Mobile back button only */
        .back-btn {
            background: #171421;
            border: 1px solid var(--grey);
            border-radius: 4px;
            padding: 0.4rem 0.75rem;
            color: var(--grey);
            font-size: 0.8rem;
            cursor: pointer;
            transition: border-color 0.2s, color 0.2s, box-shadow 0.2s;
            text-decoration: none;
        }

        .back-btn:hover {
            border-color: var(--link-blue);
            color: var(--link-blue);
            box-shadow: 0 0 8px rgba(126, 200, 255, 0.3);
        }

        .back-btn.disabled {
            opacity: 0.4;
            cursor: default;
            pointer-events: none;
        }

        .right-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .description-text {
            color: var(--moon-cream);
            line-height: 1.8;
        }

        .description-text p {
            margin-bottom: 1rem;
        }

        .desc-link {
            color: var(--magic-pink);
            cursor: pointer;
            transition: text-shadow 0.2s, color 0.2s;
        }

        .desc-link:hover,
        .desc-link.glow {
            text-shadow: 0 0 10px rgba(255, 102, 255, 0.8);
        }

        .nav-child.glow {
            border-color: rgba(255, 102, 255, 0.8);
            box-shadow: 0 0 15px rgba(255, 102, 255, 0.5);
        }

        .nav-child.glow .child-num {
            text-shadow: 0 0 8px rgba(255, 102, 255, 0.8);
        }

        /* Slideshow */
        .slideshow-container {
            text-align: center;
            padding: 0.5rem;
        }

        .slideshow-counter {
            font-family: var(--font-pixel);
            font-size: 0.6rem;
            color: var(--magic-pink);
            margin-bottom: 0.25rem;
        }

        .slideshow-hint {
            font-size: 0.75rem;
            color: var(--grey);
            font-style: italic;
        }

        /* Disabled buttons */
        .nav-child.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        .nav-child.disabled .child-num {
            color: var(--grey);
        }

        /* Navigate to section */
        .nav-section {
            margin-top: auto;
            margin-bottom: 0.75rem;
        }

        .nav-title {
            font-size: 0.85rem;
            color: var(--grey);
            margin-bottom: 0.75rem;
            font-style: italic;
        }

        .nav-list {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        /* Parent buttons - grey/blue */
        .nav-parent {
            display: flex;
            align-items: center;
            background: #171421;
            border: 1px solid var(--grey);
            border-radius: 4px;
            padding: 0.5rem 0.75rem;
            color: var(--link-blue);
            font-size: 0.85rem;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
            text-decoration: none;
        }

        .nav-parent:hover {
            border-color: var(--link-blue);
            box-shadow: 0 0 10px rgba(126, 200, 255, 0.4);
        }

        /* Child buttons - grey/magenta with numbers */
        .nav-child {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: #171421;
            border: 1px solid var(--grey);
            border-radius: 4px;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
            text-decoration: none;
        }

        .nav-child:hover {
            border-color: rgba(255, 102, 255, 0.7);
            box-shadow: 0 0 10px rgba(255, 102, 255, 0.4);
        }

        .nav-child:hover .child-num {
            text-shadow: 0 0 8px rgba(255, 102, 255, 0.6);
        }

        .child-num {
            font-family: var(--font-pixel);
            font-size: 0.5rem;
            color: #ff66ff;
            min-width: 1.5rem;
            line-height: 1.4;
            white-space: pre-line;
            transition: text-shadow 0.2s;
        }

        .child-num.back-btn {
            color: #7ec8ff;
        }

        .nav-child:hover .child-num.back-btn {
            text-shadow: 0 0 8px rgba(126, 200, 255, 0.6);
        }

        .child-title {
            font-size: 0.85rem;
            color: var(--moon-cream);
        }

        .nav-child-split {
            cursor: default;
        }

        .split-link {
            color: var(--moon-cream);
            cursor: pointer;
            transition: color 0.2s;
        }

        .split-link:hover {
            color: var(--magic-pink);
        }

        /* Terminal image grid */
        .terminal-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .terminal-thumb {
            background: #171421;
            border: 1px solid var(--grey);
            border-radius: 4px;
            padding: 0.5rem;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
            text-decoration: none;
            display: block;
        }

        .terminal-thumb:hover,
        .terminal-thumb.glow {
            border-color: rgba(255, 102, 255, 0.7);
            box-shadow: 0 0 10px rgba(255, 102, 255, 0.4);
        }

        .terminal-thumb img {
            width: 100%;
            height: auto;
            border-radius: 2px;
            display: block;
        }

        /* Learn more link */
        .learn-more-link {
            color: var(--link-blue);
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
            transition: color 0.2s;
        }

        .learn-more-link:hover {
            color: #ffffff;
        }

        .windows-note {
            font-size: 0.8rem;
            color: var(--grey);
            font-style: italic;
            margin-top: 0.5rem;
        }

        .flipbook-links {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .flipbook-label {
            font-size: 0.85rem;
            color: var(--grey);
            margin: 0;
        }

        .flipbook-btn {
            background: rgba(255, 102, 255, 0.15);
            border: 1px solid rgba(255, 102, 255, 0.4);
            border-radius: 4px;
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
            color: var(--magic-pink);
            text-decoration: none;
            transition: background 0.2s, border-color 0.2s;
        }

        .flipbook-btn:hover {
            background: rgba(255, 102, 255, 0.25);
            border-color: var(--magic-pink);
        }

        .right-footer {
            padding: 1rem 1.5rem;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            justify-content: center;
        }

        .footer-link {
            font-size: 0.8rem;
            color: var(--link-blue);
            text-decoration: none;
            transition: color 0.2s;
        }

        .footer-link:hover {
            color: #ffffff;
        }

        .footer-divider {
            color: var(--grey);
        }

        /* Tile view */
        .tile-view {
            flex: 1;
            background: rgba(10, 10, 25, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 8px;
            border: 1px solid rgba(255, 102, 255, 0.2);
            box-shadow:
                0 0 20px rgba(255, 102, 255, 0.3),
                0 0 40px rgba(255, 102, 255, 0.15);
            display: grid;
            grid-template-columns: 1fr 1fr;
            overflow: hidden;
        }

        .tile-page {
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
        }

        .tile-page-left {
        }

        .tile-page-title {
            font-family: var(--font-pixel);
            font-size: 0.6rem;
            color: var(--link-blue);
            text-align: center;
            margin-bottom: 1rem;
            text-decoration: none;
            display: block;
            transition: color 0.2s, text-shadow 0.2s;
        }

        a.tile-page-title:hover {
            color: #ffffff;
            text-shadow: 0 0 10px rgba(126, 200, 255, 0.6);
        }

        .tile-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            flex: 1;
        }

        .tile {
            background: #171421;
            border: 1px solid rgba(255, 102, 255, 0.3);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 0.5rem;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .tile:hover {
            border-color: rgba(255, 102, 255, 0.6);
            box-shadow: 0 0 15px rgba(255, 102, 255, 0.3);
        }

        .tile-title {
            font-family: var(--font-pixel);
            font-size: 0.55rem;
            color: var(--moon-cream);
            text-align: center;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .tile-desc {
            font-size: 0.7rem;
            color: var(--grey);
            text-align: center;
        }

        .tile-page-footer {
            font-size: 0.75rem;
            color: var(--grey);
            text-align: center;
            margin-top: 0.75rem;
            font-style: italic;
        }

        /* Hidden state */
        .hidden {
            display: none !important;
        }

        /* Mobile divider and title - hidden on desktop */
        .mobile-divider {
            display: none;
        }

        .mobile-title {
            display: none;
        }

        .mobile-back {
            display: none;
        }

        /* Mobile portrait */
        @media (max-width: 768px) and (orientation: portrait) {
            .manual-wrapper {
                position: relative;
                height: auto;
                min-height: 100vh;
                padding: 2vh 4vw;
                overflow-y: auto;
            }

            .manual-panel {
                grid-template-columns: 1fr;
                height: auto;
                flex: none;
            }

            .panel-left {
                min-height: auto;
                border-right: none;
                box-shadow: none;
            }

            .left-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .mobile-back {
                display: block;
            }

            .mobile-divider {
                display: block;
                height: 1px;
                background: linear-gradient(90deg, transparent, rgba(255, 102, 255, 0.4), transparent);
                margin: 1.5rem 0;
            }

            .right-header {
                display: none;
            }

            .mobile-title {
                display: none;
            }

            .right-content {
                flex: none;
                display: flex;
                flex-direction: column;
            }

            .nav-section {
                order: -1;
                margin-top: 0;
                margin-bottom: 1.5rem;
            }

            .description-text {
                order: 0;
            }

            .terminal-grid {
                order: 1;
            }

            #learnMoreArea {
                order: 2;
            }

            .tile-view {
                grid-template-columns: 1fr;
                height: auto;
            }

            .view-toggle {
                font-size: 0.65rem;
                padding: 0.25rem 0.5rem;
            }
        }

        /* Mobile landscape */
        @media (max-width: 768px) and (orientation: landscape) {
            .manual-wrapper {
                position: relative;
                height: auto;
                min-height: auto;
                padding: 2vh 4vw;
                overflow-y: visible;
            }

            .manual-panel {
                grid-template-columns: 1fr 1fr;
                height: auto;
                min-height: auto;
            }

            .panel-left, .panel-right {
                min-height: auto;
                height: auto;
            }

            .view-toggle {
                font-size: 0.65rem;
                padding: 0.25rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="manual-wrapper">
        <!-- Top bar -->
        <div class="top-bar">
            <button class="view-toggle" id="viewToggle">Change to Tile View</button>
        </div>

        <!-- Main panel - Grimoire view (default) -->
        <div class="manual-panel" id="grimoireView">
            <!-- Left column -->
            <div class="panel-left">
                <div class="left-header">
                    <h1 class="screen-title" id="screenTitle">Loading...</h1>
                    <a class="back-btn mobile-back disabled" id="mobileBackBtn">Back</a>
                </div>
                <div class="left-content">
                    <a class="focus-image-link" id="focusLink" href="#">
                        <img class="focus-image" id="focusImage" src="" alt="">
                    </a>
                </div>
                <div class="left-footer" id="leftFooter">
                    Click image for more information
                </div>
            </div>

            <!-- Mobile divider -->
            <div class="mobile-divider"></div>

            <!-- Right column -->
            <div class="panel-right">
                <div class="right-header">
                    <p class="screen-subheader" id="screenSubheader"></p>
                </div>
                <div class="right-content">
                    <h2 class="mobile-title" id="mobileTitle">Loading...</h2>
                    <div class="description-text" id="descriptionText"></div>

                    <div class="terminal-grid hidden" id="terminalGrid"></div>

                    <div class="nav-section" id="navSection">
                        <p class="nav-title">Navigate to:</p>
                        <div class="nav-list" id="navList"></div>
                    </div>

                    <div id="learnMoreArea"></div>
                </div>
                <div class="right-footer">
                    <a href="../beta-key.html" class="footer-link">Ready for a Beta Key?</a>
                    <span class="footer-divider">·</span>
                    <a href="../home.html" class="footer-link">Hub</a>
                    <span class="footer-divider">·</span>
                    <a href="https://store.steampowered.com/app/4134440/FlashBoss/" class="footer-link">Visit Steam</a>
                </div>
            </div>
        </div>

        <!-- Tile view -->
        <div class="tile-view hidden" id="tileView">
            <div class="tile-page tile-page-left">
                <a href="walkthrough/flipbook.html?path=german" class="tile-page-title" id="howToPlayLink">How to Play</a>
                <div class="tile-grid">
                    <div class="tile" onclick="selectTopic('profile-select')">
                        <span class="tile-title">Getting Started</span>
                        <span class="tile-desc">Installation & setup</span>
                    </div>
                    <div class="tile" onclick="selectTopic('tier-skip')">
                        <span class="tile-title">Tier Skip</span>
                        <span class="tile-desc">Test out of content</span>
                    </div>
                    <div class="tile" onclick="selectTopic('sanctum')">
                        <span class="tile-title">Daily Practice</span>
                        <span class="tile-desc">Streaks & reviews</span>
                    </div>
                    <div class="tile" onclick="selectTopic('bossfight')">
                        <span class="tile-title">Boss Fights</span>
                        <span class="tile-desc">Challenge clusters</span>
                    </div>
                    <div class="tile" onclick="selectTopic('grimoire')">
                        <span class="tile-title">Grimoire</span>
                        <span class="tile-desc">Streak buffer</span>
                    </div>
                    <div class="tile" onclick="selectTopic('review-gates')">
                        <span class="tile-title">Review Modes</span>
                        <span class="tile-desc">Practice options</span>
                    </div>
                </div>
                <p class="tile-page-footer">Select a tile to learn more</p>
            </div>
            <div class="tile-page">
                <a href="#" class="tile-page-title" onclick="selectTopic('about-1'); return false;">About FlashBoss</a>
                <div class="tile-grid">
                    <div class="tile" onclick="selectTopic('create-master')">
                        <span class="tile-title">Masters</span>
                        <span class="tile-desc">Choose your guide</span>
                    </div>
                    <div class="tile" onclick="selectTopic('lesson-pack-select')">
                        <span class="tile-title">Lessons</span>
                        <span class="tile-desc">Learn new words</span>
                    </div>
                    <div class="tile" onclick="selectTopic('profile-data')">
                        <span class="tile-title">Tiers</span>
                        <span class="tile-desc">Progression system</span>
                    </div>
                    <div class="tile" onclick="selectTopic('create-pack')">
                        <span class="tile-title">Language Packs</span>
                        <span class="tile-desc">German, Esperanto</span>
                    </div>
                    <div class="tile" onclick="selectTopic('terminal')">
                        <span class="tile-title">Terminal</span>
                        <span class="tile-desc">Get uncomfortable</span>
                    </div>
                    <div class="tile" onclick="selectTopic('about-1')">
                        <span class="tile-title">FAQ</span>
                        <span class="tile-desc">Common questions</span>
                    </div>
                </div>
                <p class="tile-page-footer">
                    <a href="../home.html" class="footer-link">Hub</a>
                    <span class="footer-divider">·</span>
                    <a href="https://store.steampowered.com/app/4134440/FlashBoss/" class="footer-link">Steam</a>
                </p>
            </div>
        </div>
    </div>

    <script>
        let screens = {};
        let currentFocus = 'entrance';
        let isGrimoireView = true;

        // Toggle views
        function setView(showGrimoire) {
            isGrimoireView = showGrimoire;
            document.getElementById('grimoireView').classList.toggle('hidden', !isGrimoireView);
            document.getElementById('tileView').classList.toggle('hidden', isGrimoireView);
            document.getElementById('viewToggle').textContent = isGrimoireView ? 'Change to Tile View' : 'Change to Grimoire View';
        }

        document.getElementById('viewToggle').addEventListener('click', () => {
            setView(!isGrimoireView);
        });

        // Select from tile view
        function selectTopic(screenId) {
            if (screens[screenId]) {
                currentFocus = screenId;
                renderScreen();
                setView(true);
            }
        }

        // Load screens
        fetch('screens.json')
            .then(response => response.json())
            .then(data => {
                screens = data;

                const urlParams = new URLSearchParams(window.location.search);
                const screenParam = urlParams.get('screen');
                if (screenParam && screens[screenParam]) {
                    currentFocus = screenParam;
                }

                renderScreen();
            })
            .catch(err => {
                console.error('Failed to load screens.json:', err);
                document.getElementById('screenTitle').textContent = 'Error loading data';
            });

        function renderScreen() {
            // Clean up any slideshow keyboard handlers from previous screen
            if (window.slideshowCleanup) {
                window.slideshowCleanup();
                window.slideshowCleanup = null;
            }

            const focus = screens[currentFocus];
            if (!focus) return;

            // Title
            document.getElementById('screenTitle').textContent = focus.title;
            document.getElementById('mobileTitle').textContent = focus.title;

            // Image
            const focusImage = document.getElementById('focusImage');
            const focusLink = document.getElementById('focusLink');
            if (focus.image) {
                focusImage.src = focus.image;
                focusImage.alt = focus.title;
                focusImage.style.display = 'block';
            } else {
                focusImage.style.display = 'none';
            }

            // Image link - goes to dedicated page
            if (focus.page) {
                focusLink.href = focus.page;
                focusLink.onclick = null;
            } else {
                focusLink.href = '#';
                focusLink.onclick = (e) => e.preventDefault();
            }

            // Left footer - update based on whether page exists
            const leftFooter = document.getElementById('leftFooter');
            if (focus.page) {
                leftFooter.textContent = 'Click image for more information';
            } else {
                leftFooter.textContent = '';
            }

            // Subheader - from data or empty
            const subheader = document.getElementById('screenSubheader');
            subheader.textContent = focus.subheader || '';

            // Mobile back button - goes to primary parent
            const mobileBackBtn = document.getElementById('mobileBackBtn');
            if (focus.parents && focus.parents.length > 0) {
                const firstParent = screens[focus.parents[0]];
                if (firstParent) {
                    mobileBackBtn.classList.remove('disabled');
                    mobileBackBtn.textContent = 'Back';
                    mobileBackBtn.onclick = () => {
                        currentFocus = focus.parents[0];
                        renderScreen();
                    };
                } else {
                    mobileBackBtn.classList.add('disabled');
                }
            } else {
                mobileBackBtn.classList.add('disabled');
            }

            // Check if childLabels has a "9" (back via number)
            const hasNineBack = focus.childLabels && Object.values(focus.childLabels).includes('9');

            // Description
            const descDiv = document.getElementById('descriptionText');
            descDiv.innerHTML = '';
            const descSource = focus.descriptionHTML || focus.description;
            descSource.split('\n\n').forEach(para => {
                const p = document.createElement('p');
                if (focus.descriptionHTML) {
                    p.innerHTML = para;
                } else {
                    p.textContent = para;
                }
                descDiv.appendChild(p);
            });

            // Set up desc-link hover syncing
            descDiv.querySelectorAll('.desc-link').forEach(link => {
                const targetId = link.dataset.target;
                link.onclick = () => {
                    const actualTarget = (focus.childTargets && focus.childTargets[targetId]) || targetId;
                    currentFocus = actualTarget;
                    renderScreen();
                };
                link.onmouseenter = () => {
                    link.classList.add('glow');
                    document.querySelectorAll(`.nav-child[data-target="${targetId}"]`).forEach(nav => {
                        nav.classList.add('glow');
                    });
                };
                link.onmouseleave = () => {
                    link.classList.remove('glow');
                    document.querySelectorAll('.nav-child.glow').forEach(nav => nav.classList.remove('glow'));
                };
            });

            // Terminal layout - special image grid
            const terminalGrid = document.getElementById('terminalGrid');
            if (focus.layout === 'terminal' && focus.childImages) {
                terminalGrid.innerHTML = '';
                terminalGrid.classList.remove('hidden');

                // Check for flipbook thumbnails first
                if (focus.flipbookLinks) {
                    // Render flipbook thumbnails that link to walkthrough
                    const flipbookKeys = Object.keys(focus.flipbookLinks);
                    flipbookKeys.forEach(key => {
                        const imgKey = 'flipbook-' + key;
                        const imgSrc = focus.childImages[imgKey];
                        if (!imgSrc) return;
                        const thumb = document.createElement('a');
                        thumb.className = 'terminal-thumb';
                        thumb.href = focus.flipbookLinks[key];
                        thumb.innerHTML = `<img src="${imgSrc}" alt="${key.charAt(0).toUpperCase() + key.slice(1)} Walkthrough">`;
                        terminalGrid.appendChild(thumb);
                    });
                } else {
                    // Normal terminal grid - navigate within manual
                    focus.children.forEach(childId => {
                        const imgSrc = focus.childImages[childId];
                        if (!imgSrc) return;
                        const thumb = document.createElement('a');
                        thumb.className = 'terminal-thumb';
                        thumb.dataset.target = childId;
                        thumb.innerHTML = `<img src="${imgSrc}" alt="${screens[childId]?.title || ''}">`;
                        thumb.onclick = () => {
                            currentFocus = childId;
                            renderScreen();
                        };
                        // Hover sync with nav buttons
                        thumb.onmouseenter = () => {
                            thumb.classList.add('glow');
                            document.querySelectorAll(`.nav-child[data-target="${childId}"]`).forEach(btn => {
                                btn.classList.add('glow');
                            });
                        };
                        thumb.onmouseleave = () => {
                            thumb.classList.remove('glow');
                            document.querySelectorAll('.nav-child.glow').forEach(btn => btn.classList.remove('glow'));
                        };
                        terminalGrid.appendChild(thumb);
                    });
                }
            } else if (focus.layout === 'gallery' && focus.galleryImages) {
                // Gallery layout - clicking thumbnails swaps with focus image
                terminalGrid.innerHTML = '';
                terminalGrid.classList.remove('hidden');

                focus.galleryImages.forEach((imgSrc, index) => {
                    const thumb = document.createElement('a');
                    thumb.className = 'terminal-thumb';
                    thumb.innerHTML = `<img src="${imgSrc}" alt="Gallery image ${index + 1}">`;
                    thumb.onclick = () => {
                        // Swap this thumbnail with the focus image
                        const focusImg = document.getElementById('focusImage');
                        const currentFocusSrc = focusImg.src;
                        const thumbImg = thumb.querySelector('img');

                        // Update focus image
                        focusImg.src = imgSrc;

                        // Update thumbnail to show old focus image
                        thumbImg.src = currentFocusSrc;

                        // Update the galleryImages array and focus.image for consistency
                        focus.galleryImages[index] = currentFocusSrc.replace(window.location.origin + '/', '').replace(/^.*\/manual\//, '');
                    };
                    terminalGrid.appendChild(thumb);
                });
            } else if (focus.layout === 'slideshow' && focus.slideshowImages) {
                // Slideshow layout - click to advance through images
                terminalGrid.innerHTML = '';
                terminalGrid.classList.remove('hidden');

                let currentSlide = 0;
                const totalSlides = focus.slideshowImages.length;

                const slideContainer = document.createElement('div');
                slideContainer.className = 'slideshow-container';
                slideContainer.innerHTML = `
                    <div class="slideshow-counter">${currentSlide + 1} / ${totalSlides}</div>
                    <div class="slideshow-hint">Click image or press * to advance</div>
                `;
                terminalGrid.appendChild(slideContainer);

                const advanceSlide = () => {
                    currentSlide++;
                    if (currentSlide >= totalSlides) {
                        // End of slideshow - return to sanctum
                        window.removeEventListener('keydown', handleSlideshowKey);
                        currentFocus = 'sanctum';
                        renderScreen();
                    } else {
                        const focusImg = document.getElementById('focusImage');
                        focusImg.src = focus.slideshowImages[currentSlide];
                        slideContainer.querySelector('.slideshow-counter').textContent = `${currentSlide + 1} / ${totalSlides}`;
                    }
                };

                // Make focus image clickable to advance
                const focusImg = document.getElementById('focusImage');
                const focusLink = document.getElementById('focusLink');
                focusLink.style.cursor = 'pointer';
                focusLink.onclick = (e) => {
                    e.preventDefault();
                    advanceSlide();
                };

                // Keyboard handler for * key
                const handleSlideshowKey = (e) => {
                    if (e.key === '*' || e.key === '8' && e.shiftKey) {
                        e.preventDefault();
                        advanceSlide();
                    }
                };
                window.addEventListener('keydown', handleSlideshowKey);
                // Store cleanup function for when we leave this screen
                window.slideshowCleanup = () => window.removeEventListener('keydown', handleSlideshowKey);
            } else {
                terminalGrid.classList.add('hidden');
                terminalGrid.innerHTML = '';
            }

            // Navigation list - parents then children
            const navSection = document.getElementById('navSection');
            const navList = document.getElementById('navList');
            navList.innerHTML = '';

            const hasParents = focus.parents && focus.parents.length > 0;
            const hasChildren = focus.children && focus.children.length > 0;
            const hasDisabledButtons = focus.disabledButtons && focus.disabledButtons.length > 0;
            // Hide parent buttons if "9" back option exists OR terminal layout
            const showParents = hasParents && !hasNineBack && focus.layout !== 'terminal';

            if (showParents || hasChildren || hasDisabledButtons) {
                navSection.style.display = 'block';

                // Parents first (blue) - only if no "9" back option
                if (showParents) {
                    focus.parents.forEach(parentId => {
                        const parent = screens[parentId];
                        if (!parent) return;

                        const item = document.createElement('a');
                        item.className = 'nav-parent';
                        item.textContent = '← ' + parent.title;
                        item.onclick = () => {
                            currentFocus = parentId;
                            renderScreen();
                        };
                        navList.appendChild(item);
                    });
                }

                // Children (magenta with numbers)
                if (hasChildren) {
                    // Group children by their label number
                    const childGroups = {};
                    // For slideshow layouts, skip * buttons (handled by image click/keyboard)
                    const skipLabels = focus.layout === 'slideshow' ? ['*'] : [];
                    focus.children.forEach(childId => {
                        const hasSyntheticChild = focus.childDisplayNames && focus.childDisplayNames[childId];
                        const targetId = (focus.childTargets && focus.childTargets[childId]) || childId;
                        const child = screens[targetId];
                        if (!child && !hasSyntheticChild) return;

                        const displayName = hasSyntheticChild ? focus.childDisplayNames[childId] : child.title;
                        const menuNum = focus.childLabels ? (focus.childLabels[childId] || '') : '';

                        // Skip labels that should be hidden (e.g., * for slideshows)
                        if (skipLabels.includes(menuNum)) return;

                        if (!childGroups[menuNum]) {
                            childGroups[menuNum] = [];
                        }
                        childGroups[menuNum].push({ childId, targetId, displayName, menuNum });
                    });

                    // Render grouped children
                    Object.keys(childGroups).sort((a, b) => {
                        // Sort numerically, with * first
                        if (a === '*') return -1;
                        if (b === '*') return 1;
                        return parseInt(a) - parseInt(b);
                    }).forEach(menuNum => {
                        const group = childGroups[menuNum];

                        // Expand ranges
                        let displayNum = menuNum;
                        const rangeMatch = menuNum.match(/^(\d+)-(\d+)$/);
                        if (rangeMatch) {
                            const start = parseInt(rangeMatch[1]);
                            const end = parseInt(rangeMatch[2]);
                            const nums = [];
                            for (let i = start; i <= end; i++) {
                                nums.push(i);
                            }
                            displayNum = nums.join('\n');
                        }

                        const isBackBtn = menuNum === '9';

                        if (group.length === 1) {
                            // Single item
                            const { childId, targetId, displayName } = group[0];
                            const item = document.createElement('a');
                            item.className = 'nav-child';
                            item.dataset.target = childId;
                            item.innerHTML = `
                                <span class="child-num${isBackBtn ? ' back-btn' : ''}">${displayNum}</span>
                                <span class="child-title">${displayName}</span>
                            `;
                            item.onclick = () => {
                                currentFocus = targetId;
                                renderScreen();
                            };
                            // Reverse hover - highlight desc-links and terminal thumbs when hovering nav
                            item.onmouseenter = () => {
                                item.classList.add('glow');
                                document.querySelectorAll(`.desc-link[data-target="${childId}"]`).forEach(link => {
                                    link.classList.add('glow');
                                });
                                document.querySelectorAll(`.terminal-thumb[data-target="${childId}"]`).forEach(thumb => {
                                    thumb.classList.add('glow');
                                });
                            };
                            item.onmouseleave = () => {
                                item.classList.remove('glow');
                                document.querySelectorAll('.desc-link.glow').forEach(link => link.classList.remove('glow'));
                                document.querySelectorAll('.terminal-thumb.glow').forEach(thumb => thumb.classList.remove('glow'));
                            };
                            navList.appendChild(item);
                        } else {
                            // Multiple items with same number - render as split links
                            const item = document.createElement('div');
                            item.className = 'nav-child nav-child-split';
                            const links = group.map(({ targetId, displayName }) => {
                                return `<a class="split-link" data-target="${targetId}">${displayName}</a>`;
                            }).join(' / ');
                            item.innerHTML = `
                                <span class="child-num${isBackBtn ? ' back-btn' : ''}">${displayNum}</span>
                                <span class="child-title">${links}</span>
                            `;
                            item.querySelectorAll('.split-link').forEach(link => {
                                link.onclick = () => {
                                    currentFocus = link.dataset.target;
                                    renderScreen();
                                };
                            });
                            navList.appendChild(item);
                        }
                    });
                }

                // Render disabled buttons (for slideshow audio buttons etc.)
                if (focus.disabledButtons && focus.disabledButtons.length > 0) {
                    focus.disabledButtons.forEach(btnLabel => {
                        const tooltip = focus.disabledTooltips && focus.disabledTooltips[btnLabel]
                            ? focus.disabledTooltips[btnLabel]
                            : btnLabel;
                        const item = document.createElement('div');
                        item.className = 'nav-child disabled';
                        item.title = tooltip;
                        item.innerHTML = `
                            <span class="child-num">${btnLabel}</span>
                            <span class="child-title" style="color: var(--grey);">${tooltip}</span>
                        `;
                        navList.appendChild(item);
                    });
                }
            } else {
                navSection.style.display = 'none';
            }

            // Learn more link and windows note
            const learnMoreArea = document.getElementById('learnMoreArea');
            let learnMoreHTML = '';
            if (focus.page) {
                learnMoreHTML += `<a href="${focus.page}" class="learn-more-link">Learn more</a>`;
            }
            if (focus.windowsNote) {
                learnMoreHTML += `<p class="windows-note">${focus.windowsNote}</p>`;
            }
            learnMoreArea.innerHTML = learnMoreHTML;
        }
    </script>
</body>
</html>
